---
title: "The impact of storms in the US"
author: "John Lee"
date: "24 September 2015"
output: html_document
---

Synopsis here: 10 sentences summarising analysis


# Data Processing
The following library's are used during the analaysis:
```{r}
library(data.table)
library(reshape2)
library(readr)
library(ggplot2)
```

The data used in this report is published by the U.S. National Oceanic and Atmospheric Administration's (NOAA) storm database. The database tracks characteristics of major storms and weather events in the United States, including when and where they occur, as well as estimates of any fatalities, injuries, and property damage.

The data was downloaded from the following URL:
```{r, cache = TRUE}
file_url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
if(!file.exists("storm.csv.bz2")){
    download.file(file_url, destfile = "storm.csv.bz2",method = "curl")
    
}
```

The data was read using the read_csv() function from the readr package and converted to to the data.table datatype:
```{r, results = 'hide',cache=TRUE}
storm_data <- data.table(read_csv("storm.csv.bz2"))
storm_data[,BGN_DATE:= as.POSIXct(BGN_DATE,format = "%m/%e/%Y %H:%M:%S")]
```
Pertinent to the second part of the analysis performed the following variables have no missing values:
```{r}
storm_data[,which(is.na(CROPDMG))]
storm_data[,which(is.na(CROPDMGEXP))]
storm_data[,which(is.na(PROPDMG))]
storm_data[,which(is.na(PROPDMGEXP))]
```
#Results
The data set has more than 900,000 entries with 37 variables for each entry:
```{r}
dim(storm_data)
```
## Events most harmful with respect to population health
Between the years 1950 and 2011 the total number of deaths for each of the 985 event categories was calculated. Ordered by the total fatalities, we see that tornadoes cause both death and injury many fold higher than other events. Different categories describing excessive heat indicate this is the second most common weather in which people are injured or die. Different types of storms appear to cumulatively be the next weather event to take human lives but the different categories describing such events were not merged to provide a more thorough understanding of the impact of such events.
```{r,cache=TRUE}
health_impact <- storm_data[,.(
    Total_fatalities = sum(FATALITIES),
    Total_injuries = sum(INJURIES)),
    by = EVTYPE][Total_fatalities>10]
health_impact[order(-Total_fatalities)]
```

## Events in the NOAA database with the greatest economic consequences
In assessing the economic consequences of the extreme weather events in this database we must have a closer look at the PROPDMG, PROPDMGEXP, CROPDMG, and CROPDMGEXP variables. A nice summary of these variables can be observed at the URL: https://github.com/flyingdisc/RepData_PeerAssessment2/blob/master/how-to-handle-PROPDMGEXP.md

To summarise the account given in the report at this URL, the damage to crops can be calculated by assessed by multiplying CROPDMG by CROPDMGEXP. Property damage can be obtained in a similar manner.

The values that the these variables can take are:
```{r,cache=TRUE}
storm_data[,unique(CROPDMGEXP)]
storm_data[,unique(PROPDMGEXP)]
```
The individual numbers are the exponent of scientific notation and the letters correspond to a thousand, million and billion for h (or H), m (or M) and b (or B) respectively. The multiplier vector was constructed to scale all damage values appropriately. The remaining symbols denote values that are negligible and were discarded for the analysis by simply multiplying the damage value by zero. A list of events with the greatest economic shows tornados to once again be the most damaging. Values reported for damage are in the unit of billions of U.S. dollars :

```{r}
multiplier <- c("?" = 0, "+" = 0, "-"= 0,  "0"= 1, "1"= 10, "2"= 100, "3"= 1000, "4"= 10000, "5"= 100000, "6"= 1000000, "7"= 10000000, "8"= 100000000, "B"= 1000000, "h"= 100, "H"= 100, "K"= 1000, "m"= 1000000, "M"=1000000 )
economic_impact <- storm_data[,
        .(Crop_damage = sum(na.omit(CROPDMG * multiplier[CROPDMGEXP])/(1*10^9)),
        Property_damage = sum(na.omit(PROPDMG * multiplier[PROPDMGEXP]))/(1*10^9)), 
        by = EVTYPE]
economic_impact <- economic_impact[,
            Total_damage := Property_damage+Crop_damage][order(-Total_damage)]
economic_impact[Total_damage>100]
```






df$CROPDMG <- multiplier[df$CROPDMGEXP], where multiplier is a numeric vector such that

Across the United States, which types of events have the greatest economic consequences?
